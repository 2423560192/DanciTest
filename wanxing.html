<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>英语完形填空互动题库</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap');

    body {
      font-family: 'Comic Neue', cursive;
      background-color: #f5f5f5;
      padding: 20px;
      background-image: url('https://img.freepik.com/free-vector/hand-drawn-school-background_23-2149464866.jpg');
      background-size: cover;
      background-attachment: fixed;
    }

    .container {
      background-color: rgba(255, 255, 255, 0.9);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      margin: auto;
      border: 3px solid #ffcc00;
    }

    h1 {
      text-align: center;
      color: #ff6b6b;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 2.5em;
      margin-bottom: 30px;
    }

    .sentence {
      font-size: 20px;
      line-height: 2;
      margin-bottom: 25px;
      padding: 20px;
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
      position: relative;
    }

    .sentence:hover {
      transform: scale(1.01);
    }

    .word {
      color: #4a90e2;
      font-weight: bold;
      cursor: pointer;
      position: relative;
    }

    .word-tooltip {
      visibility: hidden;
      width: 120px;
      background-color: #ffcc00;
      color: #333;
      text-align: center;
      border-radius: 8px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 16px;
      pointer-events: none;
    }

    .word:hover .word-tooltip {
      visibility: visible;
      opacity: 1;
    }

    .blank-container {
      display: inline-block;
      position: relative;
      vertical-align: middle;
      margin: 0 4px;
    }

    .blank-box {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: auto;
      min-width: 80px;
      max-width: 120px;
      height: 36px;
      background-color: #fff8e1;
      border: 1px solid #ffcc00;
      border-radius: 5px;
      margin: 0;
      padding: 0 5px;
      font-size: 18px;
      color: #333;
      position: relative;
    }
    
    .blank-content {
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.4;
      transition: opacity 0.3s;
    }

    .blank-box:focus-within .blank-content {
      opacity: 0;
    }

    .blank-hint {
      position: absolute;
      left: 0;
      right: 0;
      text-align: center;
      color: #aaa;
    }

    .blank-input {
      width: 100%;
      height: 100%;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 18px;
      font-family: 'Comic Neue', cursive;
      color: #333;
      outline: none;
      z-index: 2;
      font-weight: bold;
    }
    
    .first-letter {
      color: #4a90e2;
      font-weight: bold;
      opacity: 0.8;
    }
    
    .underline {
      display: inline-block;
      width: 10px;
      height: 2px;
      background-color: #999;
      margin: 0 1px;
      opacity: 0.6;
    }

    .blank-box.correct {
      background-color: #dff0d8;
      border-color: #5cb85c;
    }

    .blank-box.incorrect {
      background-color: #f2dede;
      border-color: #d9534f;
    }

    .translation {
      display: none;
      color: #666;
      font-style: italic;
      margin-top: 15px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 8px;
    }
    
    .hint-translation {
      display: none;
      color: #666;
      font-style: italic;
      margin-top: 15px;
      padding: 10px;
      background-color: #e0f7fa;
      border-radius: 8px;
    }

    .translation-visible {
      display: block !important;
    }
    
    .hint-word {
      color: #ff6b6b;
      font-weight: bold;
      border-bottom: 2px dotted #ff6b6b;
      padding: 0 3px;
    }

    .hint-blank {
      color: #ff6b6b;
      font-weight: bold;
      border-bottom: 2px solid #ff6b6b;
      padding: 0 3px;
    }

    .button-group {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }

    .translate-btn, .hint-btn {
      margin-left: 10px;
      background-color: #4a90e2;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .hint-btn {
      background-color: #ff9800;
    }

    .translate-btn:hover, .hint-btn:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }

    .feedback {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background-color: #4CAF50;
      color: white;
      border-radius: 10px;
      display: none;
      font-size: 18px;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    .teacher-mode {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #ff6b6b;
      color: white;
      padding: 10px 15px;
      border-radius: 50px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    .teacher-panel {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background-color: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 1000;
      width: 200px;
    }

    .teacher-panel.active {
      display: block;
    }

    .teacher-panel button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: none;
      border-radius: 5px;
      background-color: #4a90e2;
      color: white;
      cursor: pointer;
    }

    .teacher-panel button:hover {
      background-color: #3a7bc8;
    }
    
    .json-editor {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .json-editor.active {
      display: flex;
    }
    
    .json-editor-content {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow: auto;
    }
    
    .json-editor textarea {
      width: 100%;
      height: 300px;
      font-family: monospace;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    .json-editor-buttons {
      display: flex;
      justify-content: flex-end;
    }
    
    .json-editor-buttons button {
      margin-left: 10px;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .json-editor-buttons .apply-btn {
      background-color: #4CAF50;
      color: white;
    }
    
    .json-editor-buttons .cancel-btn {
      background-color: #f44336;
      color: white;
    }
  </style>
</head>
<body>

  <div class="container" id="exercise-container">
    <h1>🌟 英语完形填空互动练习 🌟</h1>
    
    <!-- 题目内容将在这里动态生成 -->
    
    </div>

  <div class="feedback" id="feedback">太棒了！继续加油！</div>
  
  <div class="teacher-mode">教师模式</div>
  <div class="teacher-panel">
    <button id="show-all-translations">显示所有翻译</button>
    <button id="hide-all-translations">隐藏所有翻译</button>
    <button id="show-all-hints">显示所有提示翻译</button>
    <button id="enable-word-hints">启用单词提示</button>
    <button id="disable-word-hints">禁用单词提示</button>
    <button id="edit-json">编辑JSON</button>
    <button id="save-local">保存到本地</button>
    <button id="load-local">加载本地数据</button>
    </div>

  <div class="json-editor">
    <div class="json-editor-content">
      <h2>编辑题目 JSON</h2>
      <textarea id="json-content"></textarea>
      <div class="json-editor-buttons">
        <button class="cancel-btn">取消</button>
        <button class="apply-btn">应用</button>
    </div>
    </div>
  </div>

  <script>
    // 默认题目数据
    const defaultExercises = [
      {
        "id": 1,
        "english": "One day, I [found] a wallet on the ground. {I} picked it up and looked {around}.",
        "translation": "有一天，我在地上捡到了一个钱包。我捡起它，看了看周围。",
        "hint_translation": "有一天，我[f___]到了一个钱包。{我}捡起它，看了看{周围}。",
        "words": [
          { "word": "found", "meaning": "找到", "isBlank": true, "answer": "found" },
          { "word": "I", "meaning": "我", "isBlank": false },
          { "word": "around", "meaning": "周围", "isBlank": false }
        ]
      },
      {
        "id": 2,
        "english": "{I} decided to [return] it to the {police station}.",
        "translation": "我决定把它交给警察局。",
        "hint_translation": "{我}决定把它[r___]到{警察局}。",
        "words": [
          { "word": "I", "meaning": "我", "isBlank": false },
          { "word": "return", "meaning": "归还", "isBlank": true, "answer": "return" },
          { "word": "police station", "meaning": "警察局", "isBlank": false }
        ]
      },
      {
        "id": 3,
        "english": "The {police} officer was very {grateful} and [praised] me.",
        "translation": "警察非常感激并称赞了我。",
        "hint_translation": "{警察}非常{感激的}并[p___]了我。",
        "words": [
          { "word": "police", "meaning": "警察", "isBlank": false },
          { "word": "grateful", "meaning": "感激的", "isBlank": false },
          { "word": "praised", "meaning": "称赞", "isBlank": true, "answer": "praised" }
        ]
      },
      {
        "id": 4,
        "english": "{It} made me feel [proud] of myself.",
        "translation": "这让我感到很自豪。",
        "hint_translation": "{它}让我感到很[p___]。",
        "words": [
          { "word": "It", "meaning": "它", "isBlank": false },
          { "word": "proud", "meaning": "自豪的", "isBlank": true, "answer": "proud" }
        ]
      }
    ];
    
    // 保存当前题目数据
    let currentExercises = JSON.parse(localStorage.getItem('exercises')) || defaultExercises;
    
    // 保存数据到本地
    function saveToLocal() {
      try {
        localStorage.setItem('exercises', JSON.stringify(currentExercises));
        showFeedback("成功保存到本地！");
      } catch (error) {
        console.error("保存到本地失败:", error);
        showFeedback("保存失败，请查看控制台");
      }
    }
    
    // 从本地加载数据
    function loadFromLocal() {
      try {
        const savedData = localStorage.getItem('exercises');
        if (!savedData) {
          showFeedback("本地没有保存的数据");
          return;
        }
        
        // 更新本地数据
        currentExercises = JSON.parse(savedData);
        
        // 重新生成练习
        generateExercises(currentExercises);
        
        showFeedback("成功加载本地数据！");
      } catch (error) {
        console.error("加载本地数据失败:", error);
        showFeedback("加载失败，使用默认题目");
        // 使用默认题目
        generateExercises(defaultExercises);
      }
    }
    
    // 绑定本地存储按钮事件
    document.getElementById('save-local').addEventListener('click', saveToLocal);
    document.getElementById('load-local').addEventListener('click', loadFromLocal);
    
    // 生成填空题
    function generateExercises(exercises) {
      const container = document.getElementById('exercise-container');
      // 保留标题
      const title = container.querySelector('h1');
      container.innerHTML = '';
      container.appendChild(title);
      
      exercises.forEach((exercise, index) => {
        const sentenceDiv = document.createElement('div');
        sentenceDiv.className = 'sentence';
        
        // 处理英文句子
        let englishText = exercise.english;
        const wordRegex = /\{([^}]+)\}|\[([^\]]+)\]/g;
        let match;
        let lastIndex = 0;
        let englishHtml = '';
        let blankCounter = 0;
        
        while ((match = wordRegex.exec(exercise.english)) !== null) {
          // 添加匹配前的文本
          englishHtml += englishText.substring(lastIndex, match.index);
          
          // 检查是否为填空词 [word] 或 重点词 {word}
          if (match[1]) { // 重点词 {word}
            const word = match[1];
            const wordInfo = exercise.words.find(w => w.word === word);
            if (wordInfo) {
              englishHtml += `<span class="word" data-meaning="${wordInfo.meaning}">${word}<span class="word-tooltip">${wordInfo.meaning}</span></span>`;
            } else {
              console.error(`找不到单词信息: ${word}`);
              englishHtml += word;
            }
          } else if (match[2]) { // 填空词 [word]
            const word = match[2];
            const wordInfo = exercise.words.find(w => w.word === word);
            if (wordInfo) {
              const inputId = `blank-${index}-${blankCounter}`;
              blankCounter++;
              
              // 生成填空框，只显示首字母
              englishHtml += `
                <div class="blank-container">
                  <div class="blank-box">
                    <div class="blank-content">
                      <span class="first-letter">${word[0]}</span>${'<span class="underline"></span>'.repeat(word.length - 1)}
                    </div>
                    <input type="text" class="blank-input" id="${inputId}" placeholder="" data-answer="${wordInfo.answer || word}">
                  </div>
                </div>
              `;
            } else {
              console.error(`找不到单词信息: ${word}`);
              englishHtml += `[${word}]`;
            }
          }
          
          lastIndex = match.index + match[0].length;
        }
        
        // 添加最后一部分文本
        englishHtml += englishText.substring(lastIndex);
        
        // 处理中文翻译
        const translationDiv = document.createElement('div');
        translationDiv.className = 'translation';
        translationDiv.textContent = exercise.translation;
        
        // 处理提示翻译
        const hintTranslationDiv = document.createElement('div');
        hintTranslationDiv.className = 'hint-translation';
        
        let hintText = exercise.hint_translation;
        const hintRegex = /\{([^}]+)\}|\[([^\]]+)\]/g;
        match = null;
        lastIndex = 0;
        let hintHtml = '';
        
        while ((match = hintRegex.exec(exercise.hint_translation)) !== null) {
          // 添加匹配前的文本
          hintHtml += hintText.substring(lastIndex, match.index);
          
          // 检查是否为填空词 [word] 或 重点词 {word}
          if (match[1]) { // 重点词 {word}
            hintHtml += `<span class="hint-word">${match[1]}</span>`;
          } else if (match[2]) { // 填空词 [word]
            hintHtml += `<span class="hint-blank">${match[2]}</span>`;
          }
          
          lastIndex = match.index + match[0].length;
        }
        
        // 添加最后一部分文本
        hintHtml += hintText.substring(lastIndex);
        
        hintTranslationDiv.innerHTML = hintHtml;
        
        // 添加按钮
        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'button-group';
        buttonGroup.innerHTML = `
          <button class="hint-btn">提示翻译</button>
          <button class="translate-btn">完整翻译</button>
        `;
        
        // 组装句子
        sentenceDiv.innerHTML = englishHtml;
        sentenceDiv.appendChild(translationDiv);
        sentenceDiv.appendChild(hintTranslationDiv);
        sentenceDiv.appendChild(buttonGroup);
        
        container.appendChild(sentenceDiv);
      });
      
      // 绑定填空验证事件和翻译按钮事件
      attachEventListeners();
    }
    
    // 绑定所有事件监听器
    function attachEventListeners() {
      // 绑定填空验证事件
      document.querySelectorAll('.blank-input').forEach(input => {
        // 当获得焦点时隐藏首字母和下划线
        input.addEventListener('focus', function() {
          this.parentElement.querySelector('.blank-content').style.opacity = '0';
        });
        
        // 当失去焦点且没有输入内容时，重新显示首字母和下划线
        input.addEventListener('blur', function() {
          if (!this.value.trim()) {
            this.parentElement.querySelector('.blank-content').style.opacity = '0.4';
          }
        });
        
        input.addEventListener('input', function() {
          let value = this.value.trim().toLowerCase();
          const answer = this.dataset.answer.toLowerCase();
          
          // 如果有输入内容，保持提示隐藏
          if (value) {
            this.parentElement.querySelector('.blank-content').style.opacity = '0';
          }
          
          if(value === answer) {
            this.parentElement.classList.add("correct");
            showFeedback("太棒了！继续加油！");
            setTimeout(() => {
              this.parentElement.classList.remove("correct");
            }, 1500);
          } else if(value.length >= answer.length) {
            // 如果输入了错误的完整单词，显示错误反馈
            this.parentElement.classList.remove("correct");
            this.parentElement.classList.add("incorrect");
            setTimeout(() => {
              this.parentElement.classList.remove("incorrect");
            }, 1500);
          }
        });
      });
      
      // 绑定翻译按钮事件
      bindTranslationEvents();
    }
    
    // 显示反馈信息
    function showFeedback(message) {
      const feedback = document.getElementById("feedback");
      feedback.textContent = message;
      feedback.style.display = "block";
      console.log("反馈信息:", message);
      setTimeout(() => {
        feedback.style.display = "none";
      }, 2000);
    }
    
    // 绑定翻译按钮事件
    function bindTranslationEvents() {
      // 翻译按钮功能
      document.querySelectorAll('.translate-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const sentence = this.closest('.sentence');
          const translation = sentence.querySelector('.translation');
          const hintTranslation = sentence.querySelector('.hint-translation');
          
          // 切换完整翻译显示状态
          translation.classList.toggle('translation-visible');
          
          // 如果提示翻译是显示的，则隐藏它
          if (hintTranslation.classList.contains('translation-visible')) {
            hintTranslation.classList.remove('translation-visible');
            sentence.querySelector('.hint-btn').textContent = '提示翻译';
          }
          
          this.textContent = translation.classList.contains('translation-visible') ? '隐藏翻译' : '完整翻译';
        });
      });
      
      // 提示翻译按钮功能
      document.querySelectorAll('.hint-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const sentence = this.closest('.sentence');
          const translation = sentence.querySelector('.translation');
          const hintTranslation = sentence.querySelector('.hint-translation');
          
          // 切换提示翻译显示状态
          hintTranslation.classList.toggle('translation-visible');
          
          // 如果完整翻译是显示的，则隐藏它
          if (translation.classList.contains('translation-visible')) {
            translation.classList.remove('translation-visible');
            sentence.querySelector('.translate-btn').textContent = '完整翻译';
          }
          
          this.textContent = hintTranslation.classList.contains('translation-visible') ? '隐藏提示' : '提示翻译';
        });
      });
    }

    // 教师模式面板
    document.querySelector('.teacher-mode').addEventListener('click', function() {
      document.querySelector('.teacher-panel').classList.toggle('active');
    });

    // 显示所有翻译
    document.getElementById('show-all-translations').addEventListener('click', function() {
      document.querySelectorAll('.translation').forEach(translation => {
        translation.classList.add('translation-visible');
      });
      document.querySelectorAll('.hint-translation').forEach(hint => {
        hint.classList.remove('translation-visible');
      });
      document.querySelectorAll('.translate-btn').forEach(btn => {
        btn.textContent = '隐藏翻译';
      });
      document.querySelectorAll('.hint-btn').forEach(btn => {
        btn.textContent = '提示翻译';
      });
    });

    // 隐藏所有翻译
    document.getElementById('hide-all-translations').addEventListener('click', function() {
      document.querySelectorAll('.translation').forEach(translation => {
        translation.classList.remove('translation-visible');
      });
      document.querySelectorAll('.hint-translation').forEach(hint => {
        hint.classList.remove('translation-visible');
      });
      document.querySelectorAll('.translate-btn').forEach(btn => {
        btn.textContent = '完整翻译';
      });
      document.querySelectorAll('.hint-btn').forEach(btn => {
        btn.textContent = '提示翻译';
      });
    });
    
    // 显示所有提示翻译
    document.getElementById('show-all-hints').addEventListener('click', function() {
      document.querySelectorAll('.hint-translation').forEach(hint => {
        hint.classList.add('translation-visible');
      });
      document.querySelectorAll('.translation').forEach(translation => {
        translation.classList.remove('translation-visible');
      });
      document.querySelectorAll('.hint-btn').forEach(btn => {
        btn.textContent = '隐藏提示';
      });
      document.querySelectorAll('.translate-btn').forEach(btn => {
        btn.textContent = '完整翻译';
      });
    });

    // 启用单词提示
    document.getElementById('enable-word-hints').addEventListener('click', function() {
      document.querySelectorAll('.word').forEach(word => {
        word.style.pointerEvents = 'auto';
      });
      showFeedback('单词提示已启用');
    });

    // 禁用单词提示
    document.getElementById('disable-word-hints').addEventListener('click', function() {
      document.querySelectorAll('.word').forEach(word => {
        word.style.pointerEvents = 'none';
      });
      showFeedback('单词提示已禁用');
    });
    
    // 编辑JSON按钮
    document.getElementById('edit-json').addEventListener('click', function() {
      document.getElementById('json-content').value = JSON.stringify(currentExercises, null, 2);
      document.querySelector('.json-editor').classList.add('active');
    });
    
    // 取消编辑
    document.querySelector('.cancel-btn').addEventListener('click', function() {
      document.querySelector('.json-editor').classList.remove('active');
    });
    
    // 应用JSON
    document.querySelector('.apply-btn').addEventListener('click', function() {
      try {
        const jsonContent = document.getElementById('json-content').value;
        const exercises = JSON.parse(jsonContent);
        currentExercises = exercises;
        localStorage.setItem('exercises', jsonContent);
        generateExercises(exercises);
        document.querySelector('.json-editor').classList.remove('active');
        showFeedback('题目已更新');
      } catch (error) {
        showFeedback('JSON格式错误');
      }
    });
    
    // 应用初始化
    function initializeApp() {
      // 从localStorage或默认数据获取题目
      try {
        let storedExercises = localStorage.getItem('exercises');
        let exercises = storedExercises ? JSON.parse(storedExercises) : defaultExercises;
        
        // 检查是否有有效的题目数据
        if (!exercises || !Array.isArray(exercises) || exercises.length === 0) {
          console.log('没有找到有效的题目数据，使用默认题目');
          exercises = defaultExercises;
          localStorage.setItem('exercises', JSON.stringify(defaultExercises));
        }
        
        // 生成题目
        currentExercises = exercises;
        generateExercises(exercises);
        console.log('页面加载完成，题目已生成，共', exercises.length, '个题目');
      } catch (error) {
        console.error('生成题目时出错:', error);
        // 发生错误时使用默认题目
        generateExercises(defaultExercises);
        showFeedback('加载题目时出错，已使用默认题目');
      }
    }

    // 初始化应用
    window.addEventListener('DOMContentLoaded', function() {
      initializeApp();
    });
  </script>

</body>
</html>
