<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‹±è¯­å®Œå½¢å¡«ç©ºäº’åŠ¨ç»ƒä¹ </title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap');

    body {
      font-family: 'Comic Neue', cursive;
      background-color: #f5f5f5;
      padding: 20px;
      background-image: url('https://img.freepik.com/free-vector/hand-drawn-school-background_23-2149464866.jpg');
      background-size: cover;
      background-attachment: fixed;
    }

    /* è‡ªå®šä¹‰é¼ æ ‡æŒ‡é’ˆ */
    .cursor {
      position: fixed;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: rgba(255, 204, 0, 0.3);
      border: 2px solid rgba(255, 107, 107, 0.7);
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 9999;
      transition: width 0.2s, height 0.2s;
      box-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
    }

    /* é¼ æ ‡ç‚¹å‡»æ—¶çš„ç‰¹æ•ˆ */
    .cursor.clicking {
      width: 50px;
      height: 50px;
      background-color: rgba(255, 107, 107, 0.3);
      border: 2px solid rgba(255, 204, 0, 0.7);
    }

    /* é¼ æ ‡æ‹–å°¾æ•ˆæœ */
    .cursor-trail {
      position: fixed;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: rgba(255, 204, 0, 0.2);
      pointer-events: none;
      z-index: 9998;
      transition: transform 0.1s, opacity 0.5s;
    }

    

    /* é¼ æ ‡æ ·å¼æ§åˆ¶åŒº */
    .mouse-controls {
      position: fixed;
      top: 85px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 9999;
    }
    
    .mouse-controls button {
      background-color: #4a90e2;
      color: white;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 5px;
      font-size: 16px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .mouse-controls button:hover {
      background-color: #3a7bc8;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .mouse-controls button.active {
      background-color: #ff6b6b;
      box-shadow: 0 4px 10px rgba(255,107,107,0.5);
      transform: translateY(-3px);
      font-weight: bold;
    }
    
    .mouse-controls button.active::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: #fff;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    /* é¼ æ ‡é«˜äº®ç‰¹æ•ˆ */
    .cursor-highlight {
      position: fixed;
      pointer-events: none;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(247, 99, 0, 0.5) 0%, rgba(255,255,0,0) 70%);
      transform: translate(-50%, -50%);
      z-index: 9999;
      transition: width 0.2s, height 0.2s;
    }

    /* é¼ æ ‡é«˜äº®å¼€å…³æ‚¬æµ®æ•ˆæœ */
    .mouse-effect-toggle:hover {
      background-color: #45a049;
    }

    .container {
      background-color: rgba(255, 255, 255, 0.9);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      margin: auto;
      border: 3px solid #ffcc00;
    }

    h1 {
      text-align: center;
      color: #ff6b6b;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 2.5em;
      margin-bottom: 30px;
    }

    .sentence {
      font-size: 20px;
      line-height: 2;
      margin-bottom: 25px;
      padding: 20px;
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s;
      position: relative;
    }

    .sentence:hover {
      transform: scale(1.01);
    }

    .word {
      color: #4a90e2;
      font-weight: bold;
      cursor: pointer;
      position: relative;
    }

    .word-tooltip {
      visibility: hidden;
      width: 120px;
      background-color: #e78617;
      color: #333;
      text-align: center;
      border-radius: 8px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 16px;
      pointer-events: none;
    }

    .word:hover .word-tooltip {
      visibility: visible;
      opacity: 1;
    }

    .blank-container {
      display: inline-block;
      position: relative;
      vertical-align: middle;
      margin: 0 4px;
    }

    .blank-box {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: auto;
      min-width: 80px;
      max-width: 120px;
      height: 36px;
      background-color: #fff8e1;
      border: 1px solid #ffcc00;
      border-radius: 5px;
      margin: 0;
      padding: 0 5px;
      font-size: 18px;
      color: #333;
      position: relative;
    }
    
    .blank-content {
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.4;
      transition: opacity 0.3s;
    }

    .blank-box:focus-within .blank-content {
      opacity: 0;
    }

    .blank-hint {
      position: absolute;
      left: 0;
      right: 0;
      text-align: center;
      color: #aaa;
    }

    .blank-input {
      width: 100%;
      height: 100%;
      border: none;
      background: transparent;
      text-align: center;
      font-size: 18px;
      font-family: 'Comic Neue', cursive;
      color: #333;
      outline: none;
      z-index: 2;
      font-weight: bold;
    }
    
    .first-letter {
      color: #4a90e2;
      font-weight: bold;
      opacity: 0.8;
    }
    
    .underline {
      display: inline-block;
      width: 10px;
      height: 2px;
      background-color: #999;
      margin: 0 1px;
      opacity: 0.6;
    }

    .blank-box.correct {
      background-color: #dff0d8;
      border-color: #5cb85c;
    }

    .blank-box.incorrect {
      background-color: #f2dede;
      border-color: #d9534f;
    }

    .translation {
      display: none;
      color: #666;
      font-style: italic;
      margin-top: 15px;
      padding: 10px;
      background-color: #f0f0f0;
      border-radius: 8px;
    }
    
    .hint-translation {
      display: none;
      color: #666;
      font-style: italic;
      margin-top: 15px;
      padding: 10px;
      background-color: #e0f7fa;
      border-radius: 8px;
    }

    /* è§£ææ¡†æ ·å¼ */
    .explanation-box {
      display: none;
      color: #333;
      margin-top: 15px;
      padding: 10px;
      background-color: #fff3e0;
      border-radius: 8px;
      border-left: 4px solid #ff9800;
    }
    
    .explanation-box.visible {
      display: block;
    }

    /* è¯­æ³•ç»“æ„å±•ç¤ºæ¡†æ ·å¼ */
    .grammar-box {
      display: none;
      color: #333;
      margin-top: 15px;
      padding: 10px;
      background-color: #e8f5e9;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    
    .grammar-box.visible {
      display: block;
    }
    
    /* è¯­æ³•ç»“æ„æ ‡è®°æ ·å¼ */
    .grammar-subject {
      color: #e91e63;
      font-weight: bold;
      padding: 0 2px;
      border-bottom: 2px solid #e91e63;
    }
    
    .grammar-verb {
      color: #2196f3;
      font-weight: bold;
      padding: 0 2px;
      border-bottom: 2px solid #2196f3;
    }
    
    .grammar-object {
      color: #ff9800;
      font-weight: bold;
      padding: 0 2px;
      border-bottom: 2px solid #ff9800;
    }
    
    .grammar-modifier {
      color: #4caf50;
      font-weight: bold;
      padding: 0 2px;
      border-bottom: 2px solid #4caf50;
    }
    
    .grammar-preposition {
      color: #9c27b0;
      font-weight: bold;
      padding: 0 2px;
      border-bottom: 2px solid #9c27b0;
    }
    
    .grammar-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px dashed #ccc;
    }
    
    .grammar-legend-item {
      display: flex;
      align-items: center;
    }
    
    .grammar-legend-color {
      width: 14px;
      height: 14px;
      margin-right: 5px;
      border-radius: 3px;
    }

    .translation-visible {
      display: block !important;
    }
    
    .hint-word {
      color: #ff6b6b;
      font-weight: bold;
      border-bottom: 2px dotted #ff6b6b;
      padding: 0 3px;
    }

    .hint-blank {
      color: #ff6b6b;
      font-weight: bold;
      border-bottom: 2px solid #ff6b6b;
      padding: 0 3px;
    }

    .button-group {
      display: flex;
      justify-content: flex-end;
      margin-top: 15px;
    }

    .translate-btn, .hint-btn, .explanation-btn, .grammar-btn, .show-answer-btn {
      margin-left: 10px;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .translate-btn {
      background-color: #4a90e2;
    }

    .hint-btn, .explanation-btn {
      background-color: #ff9800;
    }
    
    .grammar-btn {
      background-color: #4CAF50;
    }
    
    .show-answer-btn {
      background-color: #4CAF50;
    }

    .translate-btn:hover, .hint-btn:hover, .explanation-btn:hover, .grammar-btn:hover, .show-answer-btn:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }

    .feedback {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      background-color: #4CAF50;
      color: white;
      border-radius: 10px;
      display: none;
      font-size: 18px;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    .teacher-mode {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #ff6b6b;
      color: white;
      padding: 10px 15px;
      border-radius: 50px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    .teacher-panel {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background-color: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 1000;
      width: 200px;
    }

    .teacher-panel.active {
      display: block;
    }

    .teacher-panel button {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: none;
      border-radius: 5px;
      background-color: #4a90e2;
      color: white;
      cursor: pointer;
    }

    .teacher-panel button:hover {
      background-color: #3a7bc8;
    }
    
    .json-editor {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .json-editor.active {
      display: flex;
    }
    
    .json-editor-content {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow: auto;
    }
    
    .json-editor textarea {
      width: 100%;
      height: 300px;
      font-family: monospace;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    .json-editor-buttons {
      display: flex;
      justify-content: flex-end;
    }
    
    .json-editor-buttons button {
      margin-left: 10px;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .json-editor-buttons .apply-btn {
      background-color: #4CAF50;
      color: white;
    }
    
    .json-editor-buttons .cancel-btn {
      background-color: #f44336;
      color: white;
    }

    /* ç®­å¤´æŒ‡é’ˆæ ·å¼ */
    .cursor-arrow {
      position: fixed;
      width: 40px;
      height: 40px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="rgba(255,107,107,0.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h13M12 5l7 7-7 7"/></svg>');
      background-repeat: no-repeat;
      pointer-events: none;
      z-index: 9999;
      transform: translate(-50%, -50%);
      filter: drop-shadow(0 0 2px rgba(255, 204, 0, 0.9));
      display: none;
    }
    
    /* è°ƒæ•´æ§åˆ¶é¢æ¿ä¸­çš„åˆ†éš”çº¿æ ·å¼ */
    .teacher-panel hr {
      border: none;
      border-top: 1px solid #ddd;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <!-- è‡ªå®šä¹‰é¼ æ ‡æŒ‡é’ˆå…ƒç´  -->
  <div class="cursor"></div>
  <div class="cursor-highlight" style="display: none;"></div>
  <div class="cursor-arrow"></div>

  <div class="container" id="exercise-container">
    <h1>ğŸŒŸ è‹±è¯­å®Œå½¢å¡«ç©ºäº’åŠ¨ç»ƒä¹  ğŸŒŸ</h1>
    
    <!-- é¢˜ç›®å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
    
    </div>

  <div class="feedback" id="feedback">å¤ªæ£’äº†ï¼ç»§ç»­åŠ æ²¹ï¼</div>
  
  <div class="left-controls">
    <button id="show-translations" class="control-btn" data-tooltip="æ˜¾ç¤ºæˆ–éšè—æ‰€æœ‰å¥å­ç¿»è¯‘">æ˜¾ç¤ºç¿»è¯‘</button>
    <button id="show-grammar" class="control-btn" data-tooltip="æ˜¾ç¤ºæˆ–éšè—è¯­æ³•è§£æ">è¯­æ³•è§£æ</button>
    <button id="show-hints" class="control-btn" data-tooltip="æ˜¾ç¤ºæˆ–éšè—å•è¯æç¤º">æ˜¾ç¤ºæç¤º</button>
    <button id="show-explanations" class="control-btn" data-tooltip="æ˜¾ç¤ºæˆ–éšè—å•è¯è§£é‡Š">æ˜¾ç¤ºé‡Šä¹‰</button>
  </div>
  <div class="right-controls">
    <div class="mouse-controls">
      <div class="button-group">
        <button id="cursor-default" class="cursor-btn">é»˜è®¤</button>
        <button id="cursor-highlight" class="cursor-btn active">é«˜äº®</button>
        <button id="cursor-arrow" class="cursor-btn">ç®­å¤´</button>
      </div>
    </div>
    <button id="show-all-answers" class="control-btn" data-tooltip="æ˜¾ç¤ºæ‰€æœ‰ç­”æ¡ˆ">æ˜¾ç¤ºç­”æ¡ˆ</button>
  </div>
  
  <div class="teacher-mode">æ•™å¸ˆæ¨¡å¼</div>
  <div class="teacher-panel">
    <div class="control-panel">
      <h3>æ•™å¸ˆæ§åˆ¶é¢æ¿</h3>
      <div class="control-item">
        <label>
          <input type="checkbox" class="toggle-translate-btn" checked> å…è®¸æŸ¥çœ‹å®Œæ•´ç¿»è¯‘
        </label>
      </div>
      <div class="control-item">
        <label>
          <input type="checkbox" class="toggle-hint-btn" checked> å…è®¸æŸ¥çœ‹æç¤ºç¿»è¯‘
        </label>
      </div>
      <div class="control-item">
        <label>
          <input type="checkbox" class="toggle-explanation-btn" checked> å…è®¸æŸ¥çœ‹è§£æ
        </label>
      </div>
      <div class="control-item">
        <label>
          <input type="checkbox" class="toggle-grammar-btn" checked> å…è®¸æŸ¥çœ‹è¯­æ³•ç»“æ„
        </label>
      </div>
      <div class="control-item">
        <label>
          <input type="checkbox" class="toggle-show-answer-btn" checked> å…è®¸æŸ¥çœ‹ç­”æ¡ˆ
        </label>
      </div>
      <div class="control-item">
        <label>
          <input type="checkbox" class="toggle-show-all-meanings" checked> å…è®¸æŸ¥çœ‹å•è¯é‡Šä¹‰
        </label>
      </div>
    </div>
    <button id="show-all-translations">æ˜¾ç¤ºæ‰€æœ‰ç¿»è¯‘</button>
    <button id="hide-all-translations">éšè—æ‰€æœ‰ç¿»è¯‘</button>
    <button id="show-all-hints">æ˜¾ç¤ºæ‰€æœ‰æç¤ºç¿»è¯‘</button>
    <button id="show-all-explanations">æ˜¾ç¤ºæ‰€æœ‰è§£æ</button>
    <button id="hide-all-explanations">éšè—æ‰€æœ‰è§£æ</button>
    <button id="enable-word-hints">å¯ç”¨å•è¯æç¤º</button>
    <button id="disable-word-hints">ç¦ç”¨å•è¯æç¤º</button>
    <button id="edit-json">ç¼–è¾‘JSON</button>
    <button id="save-local">ä¿å­˜åˆ°æœ¬åœ°</button>
    <button id="load-local">åŠ è½½æœ¬åœ°æ•°æ®</button>
    </div>

  <div class="json-editor">
    <div class="json-editor-content">
      <h2>ç¼–è¾‘é¢˜ç›® JSON</h2>
      <textarea id="json-content"></textarea>
      <div class="json-editor-buttons">
        <button class="cancel-btn">å–æ¶ˆ</button>
        <button class="apply-btn">åº”ç”¨</button>
    </div>
    </div>
  </div>

  <script>
    // é»˜è®¤é¢˜ç›®æ•°æ®
    const defaultExercises = [
      {
        "id": 1,
        "english": "One day, I [found] a wallet on the ground. {I} picked it up and looked {around}.",
        "translation": "æœ‰ä¸€å¤©ï¼Œæˆ‘åœ¨åœ°ä¸Šæ¡åˆ°äº†ä¸€ä¸ªé’±åŒ…ã€‚æˆ‘æ¡èµ·å®ƒï¼Œçœ‹äº†çœ‹å‘¨å›´ã€‚",
        "hint_translation": "æœ‰ä¸€å¤©ï¼Œæˆ‘[f___]åˆ°äº†ä¸€ä¸ªé’±åŒ…ã€‚{æˆ‘}æ¡èµ·å®ƒï¼Œçœ‹äº†çœ‹{å‘¨å›´}ã€‚",
        "explanation": "è¿™ä¸ªå¥å­æè¿°è¿‡å»å‘ç”Ÿçš„äº‹æƒ…ï¼Œéœ€è¦ç”¨åŠ¨è¯çš„è¿‡å»å¼ã€‚findçš„è¿‡å»å¼æ˜¯foundï¼Œè¡¨ç¤º\"æ‰¾åˆ°/å‘ç°\"ï¼Œç¬¦åˆå¥å­è¯­å¢ƒï¼šåœ¨åœ°ä¸Šå¶ç„¶å‘ç°äº†ä¸€ä¸ªé’±åŒ…ã€‚",
        "grammar": {
          "structure": "One day, <span class='grammar-subject'>I</span> <span class='grammar-verb'>found</span> <span class='grammar-object'>a wallet</span> <span class='grammar-preposition'>on</span> <span class='grammar-object'>the ground</span>. <span class='grammar-subject'>I</span> <span class='grammar-verb'>picked</span> <span class='grammar-object'>it</span> <span class='grammar-modifier'>up</span> and <span class='grammar-verb'>looked</span> <span class='grammar-modifier'>around</span>.",
          "explanation": "ç¬¬ä¸€å¥æ˜¯ç®€å•å¥ï¼Œä¸»è¯­I + è°“è¯­åŠ¨è¯found + å®¾è¯­a wallet + ä»‹è¯çŸ­è¯­on the groundã€‚ç¬¬äºŒå¥æ˜¯å¹¶åˆ—å¥ï¼Œä¸»è¯­I + è°“è¯­åŠ¨è¯picked + å®¾è¯­it + å‰¯è¯up å’Œ ä¸»è¯­I(çœç•¥) + è°“è¯­åŠ¨è¯looked + å‰¯è¯aroundã€‚"
        },
        "words": [
          { "word": "found", "meaning": "æ‰¾åˆ°", "isBlank": true, "answer": "found" },
          { "word": "I", "meaning": "æˆ‘", "isBlank": false },
          { "word": "around", "meaning": "å‘¨å›´", "isBlank": false }
        ]
      },
      {
        "id": 2,
        "english": "{I} decided to [return] it to the {police station}.",
        "translation": "æˆ‘å†³å®šæŠŠå®ƒäº¤ç»™è­¦å¯Ÿå±€ã€‚",
        "hint_translation": "{æˆ‘}å†³å®šæŠŠå®ƒ[r___]åˆ°{è­¦å¯Ÿå±€}ã€‚",
        "explanation": "å¥å­è¡¨ç¤º\"æˆ‘å†³å®šæŠŠé’±åŒ…å½’è¿˜åˆ°è­¦å¯Ÿå±€\"ï¼Œéœ€è¦ç”¨åŠ¨è¯åŸå½¢return(å½’è¿˜)ã€‚æ­¤å¤„decided toåæ¥åŠ¨è¯åŸå½¢ï¼Œè¡¨ç¤ºå†³å®šåšæŸäº‹ã€‚",
        "grammar": {
          "structure": "<span class='grammar-subject'>I</span> <span class='grammar-verb'>decided</span> <span class='grammar-modifier'>to</span> <span class='grammar-verb'>return</span> <span class='grammar-object'>it</span> <span class='grammar-preposition'>to</span> <span class='grammar-object'>the police station</span>.",
          "explanation": "è¿™æ˜¯ä¸€ä¸ªå«æœ‰ä¸å®šå¼çš„å¥å­ã€‚ä¸»è¯­I + è°“è¯­åŠ¨è¯decided + ä¸å®šå¼to returnä½œç›®çš„çŠ¶è¯­ + å®¾è¯­it + ä»‹è¯çŸ­è¯­to the police stationè¡¨ç¤ºæ–¹å‘ã€‚"
        },
        "words": [
          { "word": "I", "meaning": "æˆ‘", "isBlank": false },
          { "word": "return", "meaning": "å½’è¿˜", "isBlank": true, "answer": "return" },
          { "word": "police station", "meaning": "è­¦å¯Ÿå±€", "isBlank": false }
        ]
      },
      {
        "id": 3,
        "english": "The {police} officer was very {grateful} and [praised] me.",
        "translation": "è­¦å¯Ÿéå¸¸æ„Ÿæ¿€å¹¶ç§°èµäº†æˆ‘ã€‚",
        "hint_translation": "{è­¦å¯Ÿ}éå¸¸{æ„Ÿæ¿€çš„}å¹¶[p___]äº†æˆ‘ã€‚",
        "explanation": "å¥å­æè¿°è¿‡å»å‘ç”Ÿçš„äº‹æƒ…ï¼Œéœ€è¦ç”¨åŠ¨è¯çš„è¿‡å»å¼ã€‚praiseçš„è¿‡å»å¼æ˜¯praisedï¼Œè¡¨ç¤º\"ç§°èµ\"ï¼Œç¬¦åˆæƒ…å¢ƒï¼šè­¦å¯Ÿå› ä¸ºæˆ‘å½’è¿˜é’±åŒ…è€Œç§°èµæˆ‘ã€‚",
        "grammar": {
          "structure": "<span class='grammar-subject'>The police officer</span> <span class='grammar-verb'>was</span> <span class='grammar-modifier'>very</span> <span class='grammar-modifier'>grateful</span> and <span class='grammar-verb'>praised</span> <span class='grammar-object'>me</span>.",
          "explanation": "è¿™æ˜¯ä¸€ä¸ªå¹¶åˆ—è°“è¯­çš„å¥å­ã€‚ä¸»è¯­The police officer + ç³»åŠ¨è¯was + è¡¨è¯­very gratefulå’Œè°“è¯­åŠ¨è¯praised + å®¾è¯­meã€‚ä¸¤ä¸ªè°“è¯­ç”±è¿è¯andè¿æ¥ã€‚"
        },
        "words": [
          { "word": "police", "meaning": "è­¦å¯Ÿ", "isBlank": false },
          { "word": "grateful", "meaning": "æ„Ÿæ¿€çš„", "isBlank": false },
          { "word": "praised", "meaning": "ç§°èµ", "isBlank": true, "answer": "praised" }
        ]
      },
      {
        "id": 4,
        "english": "{It} made me feel [proud] of myself.",
        "translation": "è¿™è®©æˆ‘æ„Ÿåˆ°å¾ˆè‡ªè±ªã€‚",
        "hint_translation": "{å®ƒ}è®©æˆ‘æ„Ÿåˆ°å¾ˆ[p___]ã€‚",
        "explanation": "feelåéœ€è¦å½¢å®¹è¯ä½œä¸ºè¡¥è¯­ï¼Œæè¿°æ„Ÿå—ã€‚proudæ˜¯å½¢å®¹è¯ï¼Œè¡¨ç¤º\"è‡ªè±ªçš„\"ï¼Œç¬¦åˆæƒ…å¢ƒï¼šå› ä¸ºåšäº†å¥½äº‹è€Œæ„Ÿåˆ°è‡ªè±ªã€‚",
        "grammar": {
          "structure": "<span class='grammar-subject'>It</span> <span class='grammar-verb'>made</span> <span class='grammar-object'>me</span> <span class='grammar-verb'>feel</span> <span class='grammar-modifier'>proud</span> <span class='grammar-preposition'>of</span> <span class='grammar-object'>myself</span>.",
          "explanation": "è¿™æ˜¯ä¸€ä¸ªå¤åˆå¥å‹ï¼šä¸»è¯­It + è°“è¯­åŠ¨è¯made + å®¾è¯­me + å®¾è¯­è¡¥è¶³è¯­feel proud of myselfã€‚å…¶ä¸­ï¼Œfeelä¸ºéè°“è¯­åŠ¨è¯ï¼Œproudä¸ºå½¢å®¹è¯ä½œæ„Ÿå®˜åŠ¨è¯feelçš„è¡¥è¯­ï¼Œof myselfä¸ºä»‹è¯çŸ­è¯­ä¿®é¥°proudã€‚"
        },
        "words": [
          { "word": "It", "meaning": "å®ƒ", "isBlank": false },
          { "word": "proud", "meaning": "è‡ªè±ªçš„", "isBlank": true, "answer": "proud" }
        ]
      }
    ];
    
    // ä¿å­˜å½“å‰é¢˜ç›®æ•°æ®
    let currentExercises = JSON.parse(localStorage.getItem('exercises')) || defaultExercises;
    
    // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°
    function saveToLocal() {
      try {
        localStorage.setItem('exercises', JSON.stringify(currentExercises));
        showFeedback("æˆåŠŸä¿å­˜åˆ°æœ¬åœ°ï¼");
      } catch (error) {
        console.error("ä¿å­˜åˆ°æœ¬åœ°å¤±è´¥:", error);
        showFeedback("ä¿å­˜å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°");
      }
    }
    
    // ä»æœ¬åœ°åŠ è½½æ•°æ®
    function loadFromLocal() {
      try {
        const savedData = localStorage.getItem('exercises');
        if (!savedData) {
          showFeedback("æœ¬åœ°æ²¡æœ‰ä¿å­˜çš„æ•°æ®");
          return;
        }
        
        // æ›´æ–°æœ¬åœ°æ•°æ®
        currentExercises = JSON.parse(savedData);
        
        // é‡æ–°ç”Ÿæˆç»ƒä¹ 
        generateExercises(currentExercises);
        
        showFeedback("æˆåŠŸåŠ è½½æœ¬åœ°æ•°æ®ï¼");
      } catch (error) {
        console.error("åŠ è½½æœ¬åœ°æ•°æ®å¤±è´¥:", error);
        showFeedback("åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é¢˜ç›®");
        // ä½¿ç”¨é»˜è®¤é¢˜ç›®
        generateExercises(defaultExercises);
      }
    }
    
    // ç»‘å®šæœ¬åœ°å­˜å‚¨æŒ‰é’®äº‹ä»¶
    document.getElementById('save-local').addEventListener('click', saveToLocal);
    document.getElementById('load-local').addEventListener('click', loadFromLocal);
    
    // ç”Ÿæˆå¡«ç©ºé¢˜
    function generateExercises(exercises) {
      const container = document.getElementById('exercise-container');
      // ä¿ç•™æ ‡é¢˜
      const title = container.querySelector('h1');
      container.innerHTML = '';
      container.appendChild(title);
      
      exercises.forEach((exercise, index) => {
        const sentenceDiv = document.createElement('div');
        sentenceDiv.className = 'sentence';
        
        // å¤„ç†è‹±æ–‡å¥å­
        let englishText = exercise.english;
        const wordRegex = /\{([^}]+)\}|\[([^\]]+)\]/g;
        let match;
        let lastIndex = 0;
        let englishHtml = '';
        let blankCounter = 0;
        
        while ((match = wordRegex.exec(exercise.english)) !== null) {
          // æ·»åŠ åŒ¹é…å‰çš„æ–‡æœ¬
          englishHtml += englishText.substring(lastIndex, match.index);
          
          // æ£€æŸ¥æ˜¯å¦ä¸ºå¡«ç©ºè¯ [word] æˆ– é‡ç‚¹è¯ {word}
          if (match[1]) { // é‡ç‚¹è¯ {word}
            const word = match[1];
            const wordInfo = exercise.words.find(w => w.word === word);
            if (wordInfo) {
              englishHtml += `<span class="word" data-meaning="${wordInfo.meaning}">${word}<span class="word-tooltip">${wordInfo.meaning}</span></span>`;
            } else {
              console.error(`æ‰¾ä¸åˆ°å•è¯ä¿¡æ¯: ${word}`);
              englishHtml += word;
            }
          } else if (match[2]) { // å¡«ç©ºè¯ [word]
            const word = match[2];
            const wordInfo = exercise.words.find(w => w.word === word);
            if (wordInfo) {
              const inputId = `blank-${index}-${blankCounter}`;
              blankCounter++;
              
              // ç”Ÿæˆå¡«ç©ºæ¡†ï¼Œåªæ˜¾ç¤ºé¦–å­—æ¯
              englishHtml += `
                <div class="blank-container">
                  <div class="blank-box">
                    <div class="blank-content">
                      <span class="first-letter">${word[0]}</span>${'<span class="underline"></span>'.repeat(word.length - 1)}
                    </div>
                    <input type="text" class="blank-input" id="${inputId}" placeholder="" data-answer="${wordInfo.answer || word}">
                  </div>
                </div>
              `;
            } else {
              console.error(`æ‰¾ä¸åˆ°å•è¯ä¿¡æ¯: ${word}`);
              englishHtml += `[${word}]`;
            }
          }
          
          lastIndex = match.index + match[0].length;
        }
        
        // æ·»åŠ æœ€åä¸€éƒ¨åˆ†æ–‡æœ¬
        englishHtml += englishText.substring(lastIndex);
        
        // å¤„ç†ä¸­æ–‡ç¿»è¯‘
        const translationDiv = document.createElement('div');
        translationDiv.className = 'translation';
        translationDiv.textContent = exercise.translation;
        
        // å¤„ç†æç¤ºç¿»è¯‘
        const hintTranslationDiv = document.createElement('div');
        hintTranslationDiv.className = 'hint-translation';
        
        let hintText = exercise.hint_translation;
        const hintRegex = /\{([^}]+)\}|\[([^\]]+)\]/g;
        match = null;
        lastIndex = 0;
        let hintHtml = '';
        
        while ((match = hintRegex.exec(exercise.hint_translation)) !== null) {
          // æ·»åŠ åŒ¹é…å‰çš„æ–‡æœ¬
          hintHtml += hintText.substring(lastIndex, match.index);
          
          // æ£€æŸ¥æ˜¯å¦ä¸ºå¡«ç©ºè¯ [word] æˆ– é‡ç‚¹è¯ {word}
          if (match[1]) { // é‡ç‚¹è¯ {word}
            hintHtml += `<span class="hint-word">${match[1]}</span>`;
          } else if (match[2]) { // å¡«ç©ºè¯ [word]
            hintHtml += `<span class="hint-blank">${match[2]}</span>`;
          }
          
          lastIndex = match.index + match[0].length;
        }
        
        // æ·»åŠ æœ€åä¸€éƒ¨åˆ†æ–‡æœ¬
        hintHtml += hintText.substring(lastIndex);
        
        hintTranslationDiv.innerHTML = hintHtml;
        
        // æ·»åŠ è§£ææ¡†
        const explanationDiv = document.createElement('div');
        explanationDiv.className = 'explanation-box';
        explanationDiv.innerHTML = exercise.explanation || 'æš‚æ— è§£æ';
        
        // æ·»åŠ è¯­æ³•ç»“æ„æ¡†
        const grammarDiv = document.createElement('div');
        grammarDiv.className = 'grammar-box';
        
        // æ£€æŸ¥æ˜¯å¦æœ‰è¯­æ³•ç»“æ„æ•°æ®
        if (exercise.grammar) {
          // æ·»åŠ å¥å­çš„è¯­æ³•ç»“æ„æ ‡è®°
          grammarDiv.innerHTML = `
            <div>${exercise.grammar.structure}</div>
            <div style="margin-top: 10px;">${exercise.grammar.explanation}</div>
            <div class="grammar-legend">
              <div class="grammar-legend-item">
                <div class="grammar-legend-color" style="background-color: #e91e63;"></div>
                <div>ä¸»è¯­</div>
              </div>
              <div class="grammar-legend-item">
                <div class="grammar-legend-color" style="background-color: #2196f3;"></div>
                <div>è°“è¯­</div>
              </div>
              <div class="grammar-legend-item">
                <div class="grammar-legend-color" style="background-color: #ff9800;"></div>
                <div>å®¾è¯­</div>
              </div>
              <div class="grammar-legend-item">
                <div class="grammar-legend-color" style="background-color: #4caf50;"></div>
                <div>ä¿®é¥°è¯­</div>
              </div>
              <div class="grammar-legend-item">
                <div class="grammar-legend-color" style="background-color: #9c27b0;"></div>
                <div>ä»‹è¯</div>
              </div>
            </div>
          `;
        } else {
          grammarDiv.innerHTML = 'æš‚æ— è¯­æ³•ç»“æ„åˆ†æ';
        }
        
        // æ·»åŠ æŒ‰é’®
        const buttonGroup = document.createElement('div');
        buttonGroup.className = 'button-group';
        buttonGroup.innerHTML = `
          <button class="hint-btn">æç¤ºç¿»è¯‘</button>
          <button class="translate-btn">å®Œæ•´ç¿»è¯‘</button>
          <button class="explanation-btn">è§£æ</button>
          <button class="grammar-btn">è¯­æ³•ç»“æ„</button>
          <button class="show-answer-btn">æ˜¾ç¤ºç­”æ¡ˆ</button>
        `;
        
        // ç»„è£…å¥å­
        sentenceDiv.innerHTML = englishHtml;
        sentenceDiv.appendChild(translationDiv);
        sentenceDiv.appendChild(hintTranslationDiv);
        sentenceDiv.appendChild(explanationDiv);
        sentenceDiv.appendChild(grammarDiv);
        sentenceDiv.appendChild(buttonGroup);
        
        container.appendChild(sentenceDiv);
      });
      
      // ç»‘å®šå¡«ç©ºéªŒè¯äº‹ä»¶å’Œç¿»è¯‘æŒ‰é’®äº‹ä»¶
      attachEventListeners();
    }
    
    // ç»‘å®šæ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
    function attachEventListeners() {
      // ç»‘å®šå¡«ç©ºéªŒè¯äº‹ä»¶
      document.querySelectorAll('.blank-input').forEach(input => {
        // å½“è·å¾—ç„¦ç‚¹æ—¶éšè—é¦–å­—æ¯å’Œä¸‹åˆ’çº¿
        input.addEventListener('focus', function() {
          this.parentElement.querySelector('.blank-content').style.opacity = '0';
        });
        
        // å½“å¤±å»ç„¦ç‚¹ä¸”æ²¡æœ‰è¾“å…¥å†…å®¹æ—¶ï¼Œé‡æ–°æ˜¾ç¤ºé¦–å­—æ¯å’Œä¸‹åˆ’çº¿
        input.addEventListener('blur', function() {
          if (!this.value.trim()) {
            this.parentElement.querySelector('.blank-content').style.opacity = '0.4';
          }
        });
        
        input.addEventListener('input', function() {
          let value = this.value.trim().toLowerCase();
          const answer = this.dataset.answer.toLowerCase();
          
          // å¦‚æœæœ‰è¾“å…¥å†…å®¹ï¼Œä¿æŒæç¤ºéšè—
          if (value) {
            this.parentElement.querySelector('.blank-content').style.opacity = '0';
          }
          
          if(value === answer) {
            this.parentElement.classList.add("correct");
            showFeedback("å¤ªæ£’äº†ï¼ç»§ç»­åŠ æ²¹ï¼");
            setTimeout(() => {
              this.parentElement.classList.remove("correct");
            }, 1500);
          } else if(value.length >= answer.length) {
            // å¦‚æœè¾“å…¥äº†é”™è¯¯çš„å®Œæ•´å•è¯ï¼Œæ˜¾ç¤ºé”™è¯¯åé¦ˆ
            this.parentElement.classList.remove("correct");
            this.parentElement.classList.add("incorrect");
            setTimeout(() => {
              this.parentElement.classList.remove("incorrect");
            }, 1500);
          }
        });
      });
      
      // ç»‘å®šç¿»è¯‘æŒ‰é’®äº‹ä»¶
      bindTranslationEvents();
    }
    
    // æ˜¾ç¤ºåé¦ˆä¿¡æ¯
    function showFeedback(message) {
      const feedback = document.getElementById("feedback");
      feedback.textContent = message;
      feedback.style.display = "block";
      console.log("åé¦ˆä¿¡æ¯:", message);
      setTimeout(() => {
        feedback.style.display = "none";
      }, 2000);
    }
    
    // ç»‘å®šç¿»è¯‘æŒ‰é’®äº‹ä»¶
    function bindTranslationEvents() {
      // ç¿»è¯‘æŒ‰é’®åŠŸèƒ½
      document.querySelectorAll('.translate-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const sentence = this.closest('.sentence');
          const translation = sentence.querySelector('.translation');
          const hintTranslation = sentence.querySelector('.hint-translation');
          const explanation = sentence.querySelector('.explanation-box');
          const grammar = sentence.querySelector('.grammar-box');
          
          // åˆ‡æ¢å®Œæ•´ç¿»è¯‘æ˜¾ç¤ºçŠ¶æ€
          translation.classList.toggle('translation-visible');
          
          // å¦‚æœæç¤ºç¿»è¯‘æ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
          if (hintTranslation.classList.contains('translation-visible')) {
            hintTranslation.classList.remove('translation-visible');
            sentence.querySelector('.hint-btn').textContent = 'æç¤ºç¿»è¯‘';
          }
          
          // å¦‚æœè§£ææ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
          if (explanation.classList.contains('visible')) {
            explanation.classList.remove('visible');
            sentence.querySelector('.explanation-btn').textContent = 'è§£æ';
          }
          
          // å¦‚æœè¯­æ³•ç»“æ„æ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
          if (grammar.classList.contains('visible')) {
            grammar.classList.remove('visible');
            sentence.querySelector('.grammar-btn').textContent = 'è¯­æ³•ç»“æ„';
          }
          
          this.textContent = translation.classList.contains('translation-visible') ? 'éšè—ç¿»è¯‘' : 'å®Œæ•´ç¿»è¯‘';
        });
      });
      
      // æç¤ºç¿»è¯‘æŒ‰é’®åŠŸèƒ½
      document.querySelectorAll('.hint-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const sentence = this.closest('.sentence');
          const translation = sentence.querySelector('.translation');
          const hintTranslation = sentence.querySelector('.hint-translation');
          const explanation = sentence.querySelector('.explanation-box');
          const grammar = sentence.querySelector('.grammar-box');
          
          // åˆ‡æ¢æç¤ºç¿»è¯‘æ˜¾ç¤ºçŠ¶æ€
          hintTranslation.classList.toggle('translation-visible');
          
          // å¦‚æœå®Œæ•´ç¿»è¯‘æ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
          if (translation.classList.contains('translation-visible')) {
            translation.classList.remove('translation-visible');
            sentence.querySelector('.translate-btn').textContent = 'å®Œæ•´ç¿»è¯‘';
          }
          
          // å¦‚æœè§£ææ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
          if (explanation.classList.contains('visible')) {
            explanation.classList.remove('visible');
            sentence.querySelector('.explanation-btn').textContent = 'è§£æ';
          }
          
          // å¦‚æœè¯­æ³•ç»“æ„æ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
          if (grammar.classList.contains('visible')) {
            grammar.classList.remove('visible');
            sentence.querySelector('.grammar-btn').textContent = 'è¯­æ³•ç»“æ„';
          }
          
          this.textContent = hintTranslation.classList.contains('translation-visible') ? 'éšè—æç¤º' : 'æç¤ºç¿»è¯‘';
        });
      });
      
      // è§£ææŒ‰é’®åŠŸèƒ½
      document.querySelectorAll('.explanation-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const sentence = this.closest('.sentence');
          const translation = sentence.querySelector('.translation');
          const hintTranslation = sentence.querySelector('.hint-translation');
          const explanation = sentence.querySelector('.explanation-box');
          const grammar = sentence.querySelector('.grammar-box');
          
          // åˆ‡æ¢è§£ææ˜¾ç¤ºçŠ¶æ€
          explanation.classList.toggle('visible');
          
          // å¦‚æœç¿»è¯‘æ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
          if (translation.classList.contains('translation-visible')) {
            translation.classList.remove('translation-visible');
            sentence.querySelector('.translate-btn').textContent = 'å®Œæ•´ç¿»è¯‘';
          }
          
          // å¦‚æœæç¤ºç¿»è¯‘æ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
          if (hintTranslation.classList.contains('translation-visible')) {
            hintTranslation.classList.remove('translation-visible');
            sentence.querySelector('.hint-btn').textContent = 'æç¤ºç¿»è¯‘';
          }
          
          // å¦‚æœè¯­æ³•ç»“æ„æ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
          if (grammar.classList.contains('visible')) {
            grammar.classList.remove('visible');
            sentence.querySelector('.grammar-btn').textContent = 'è¯­æ³•ç»“æ„';
          }
          
          this.textContent = explanation.classList.contains('visible') ? 'éšè—è§£æ' : 'è§£æ';
        });
      });

      // è¯­æ³•ç»“æ„æŒ‰é’®åŠŸèƒ½
      document.querySelectorAll('.grammar-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const sentence = this.closest('.sentence');
          const translation = sentence.querySelector('.translation');
          const hintTranslation = sentence.querySelector('.hint-translation');
          const explanation = sentence.querySelector('.explanation-box');
          const grammar = sentence.querySelector('.grammar-box');
          
          // åˆ‡æ¢è¯­æ³•ç»“æ„æ˜¾ç¤ºçŠ¶æ€
          grammar.classList.toggle('visible');
          
          // å¦‚æœç¿»è¯‘æ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
          if (translation.classList.contains('translation-visible')) {
            translation.classList.remove('translation-visible');
            sentence.querySelector('.translate-btn').textContent = 'å®Œæ•´ç¿»è¯‘';
          }
          
          // å¦‚æœæç¤ºç¿»è¯‘æ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
          if (hintTranslation.classList.contains('translation-visible')) {
            hintTranslation.classList.remove('translation-visible');
            sentence.querySelector('.hint-btn').textContent = 'æç¤ºç¿»è¯‘';
          }
          
          // å¦‚æœè§£ææ˜¯æ˜¾ç¤ºçš„ï¼Œåˆ™éšè—å®ƒ
          if (explanation.classList.contains('visible')) {
            explanation.classList.remove('visible');
            sentence.querySelector('.explanation-btn').textContent = 'è§£æ';
          }
          
          this.textContent = grammar.classList.contains('visible') ? 'éšè—è¯­æ³•' : 'è¯­æ³•ç»“æ„';
        });
      });

      // æ˜¾ç¤ºç­”æ¡ˆæŒ‰é’®åŠŸèƒ½
      document.querySelectorAll('.show-answer-btn').forEach(btn => {
        let answersShown = false;

        btn.addEventListener('click', function() {
          const sentence = this.closest('.sentence');
          const inputs = sentence.querySelectorAll('.blank-input');
          
          if (!answersShown) {
            // æ˜¾ç¤ºè¯¥å¥å­çš„æ‰€æœ‰ç­”æ¡ˆ
            inputs.forEach(input => {
              const answer = input.dataset.answer;
              input.value = answer;
              input.parentElement.querySelector('.blank-content').style.opacity = '0';
              input.parentElement.classList.add("correct");
              input.setAttribute('readonly', true);
            });
            this.textContent = 'éšè—ç­”æ¡ˆ';
            answersShown = true;
          } else {
            // éšè—è¯¥å¥å­çš„æ‰€æœ‰ç­”æ¡ˆ
            inputs.forEach(input => {
              input.value = '';
              input.parentElement.querySelector('.blank-content').style.opacity = '0.4';
              input.parentElement.classList.remove("correct");
              input.removeAttribute('readonly');
            });
            this.textContent = 'æ˜¾ç¤ºç­”æ¡ˆ';
            answersShown = false;
          }
        });
      });
    }

    // æ•™å¸ˆæ¨¡å¼é¢æ¿
    document.querySelector('.teacher-mode').addEventListener('click', function() {
      document.querySelector('.teacher-panel').classList.toggle('active');
    });

    // æ˜¾ç¤ºæ‰€æœ‰ç¿»è¯‘
    document.getElementById('show-all-translations').addEventListener('click', function() {
      document.querySelectorAll('.translation').forEach(translation => {
        translation.classList.add('translation-visible');
      });
      document.querySelectorAll('.hint-translation').forEach(hint => {
        hint.classList.remove('translation-visible');
      });
      document.querySelectorAll('.translate-btn').forEach(btn => {
        btn.textContent = 'éšè—ç¿»è¯‘';
      });
      document.querySelectorAll('.hint-btn').forEach(btn => {
        btn.textContent = 'æç¤ºç¿»è¯‘';
      });
    });

    // éšè—æ‰€æœ‰ç¿»è¯‘
    document.getElementById('hide-all-translations').addEventListener('click', function() {
      document.querySelectorAll('.translation').forEach(translation => {
        translation.classList.remove('translation-visible');
      });
      document.querySelectorAll('.hint-translation').forEach(hint => {
        hint.classList.remove('translation-visible');
      });
      document.querySelectorAll('.explanation-box').forEach(explanation => {
        explanation.classList.remove('visible');
      });
      document.querySelectorAll('.translate-btn').forEach(btn => {
        btn.textContent = 'å®Œæ•´ç¿»è¯‘';
      });
      document.querySelectorAll('.hint-btn').forEach(btn => {
        btn.textContent = 'æç¤ºç¿»è¯‘';
      });
      document.querySelectorAll('.explanation-btn').forEach(btn => {
        btn.textContent = 'è§£æ';
      });
      showFeedback('å·²éšè—æ‰€æœ‰ç¿»è¯‘å’Œè§£æ');
    });
    
    // æ˜¾ç¤ºæ‰€æœ‰æç¤ºç¿»è¯‘
    document.getElementById('show-all-hints').addEventListener('click', function() {
      document.querySelectorAll('.hint-translation').forEach(hint => {
        hint.classList.add('translation-visible');
      });
      document.querySelectorAll('.translation').forEach(translation => {
        translation.classList.remove('translation-visible');
      });
      document.querySelectorAll('.explanation-box').forEach(explanation => {
        explanation.classList.remove('visible');
      });
      document.querySelectorAll('.hint-btn').forEach(btn => {
        btn.textContent = 'éšè—æç¤º';
      });
      document.querySelectorAll('.translate-btn').forEach(btn => {
        btn.textContent = 'å®Œæ•´ç¿»è¯‘';
      });
      document.querySelectorAll('.explanation-btn').forEach(btn => {
        btn.textContent = 'è§£æ';
      });
      showFeedback('å·²æ˜¾ç¤ºæ‰€æœ‰æç¤ºç¿»è¯‘');
    });

    // æ˜¾ç¤ºæ‰€æœ‰è§£æ
    document.getElementById('show-all-explanations').addEventListener('click', function() {
      document.querySelectorAll('.explanation-box').forEach(explanation => {
        explanation.classList.add('visible');
      });
      document.querySelectorAll('.translation').forEach(translation => {
        translation.classList.remove('translation-visible');
      });
      document.querySelectorAll('.hint-translation').forEach(hint => {
        hint.classList.remove('translation-visible');
      });
      document.querySelectorAll('.explanation-btn').forEach(btn => {
        btn.textContent = 'éšè—è§£æ';
      });
      document.querySelectorAll('.translate-btn').forEach(btn => {
        btn.textContent = 'å®Œæ•´ç¿»è¯‘';
      });
      document.querySelectorAll('.hint-btn').forEach(btn => {
        btn.textContent = 'æç¤ºç¿»è¯‘';
      });
      showFeedback('å·²æ˜¾ç¤ºæ‰€æœ‰è§£æ');
    });
    
    // éšè—æ‰€æœ‰è§£æ
    document.getElementById('hide-all-explanations').addEventListener('click', function() {
      document.querySelectorAll('.explanation-box').forEach(explanation => {
        explanation.classList.remove('visible');
      });
      document.querySelectorAll('.explanation-btn').forEach(btn => {
        btn.textContent = 'è§£æ';
      });
      showFeedback('å·²éšè—æ‰€æœ‰è§£æ');
    });

    // å¯ç”¨å•è¯æç¤º
    document.getElementById('enable-word-hints').addEventListener('click', function() {
      document.querySelectorAll('.word').forEach(word => {
        word.style.pointerEvents = 'auto';
      });
      showFeedback('å•è¯æç¤ºå·²å¯ç”¨');
    });

    // ç¦ç”¨å•è¯æç¤º
    document.getElementById('disable-word-hints').addEventListener('click', function() {
      document.querySelectorAll('.word').forEach(word => {
        word.style.pointerEvents = 'none';
      });
      showFeedback('å•è¯æç¤ºå·²ç¦ç”¨');
    });
    
    // ç¼–è¾‘JSONæŒ‰é’®
    document.getElementById('edit-json').addEventListener('click', function() {
      document.getElementById('json-content').value = JSON.stringify(currentExercises, null, 2);
      document.querySelector('.json-editor').classList.add('active');
    });
    
    // å–æ¶ˆç¼–è¾‘
    document.querySelector('.cancel-btn').addEventListener('click', function() {
      document.querySelector('.json-editor').classList.remove('active');
    });
    
    // åº”ç”¨JSON
    document.querySelector('.apply-btn').addEventListener('click', function() {
      try {
        const jsonContent = document.getElementById('json-content').value;
        const exercises = JSON.parse(jsonContent);
        currentExercises = exercises;
        localStorage.setItem('exercises', jsonContent);
        generateExercises(exercises);
        document.querySelector('.json-editor').classList.remove('active');
        showFeedback('é¢˜ç›®å·²æ›´æ–°');
      } catch (error) {
        showFeedback('JSONæ ¼å¼é”™è¯¯');
      }
    });
    
    // åº”ç”¨åˆå§‹åŒ–
    function initializeApp() {
      // ä»localStorageæˆ–é»˜è®¤æ•°æ®è·å–é¢˜ç›®
      try {
        let storedExercises = localStorage.getItem('exercises');
        let exercises = storedExercises ? JSON.parse(storedExercises) : defaultExercises;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„é¢˜ç›®æ•°æ®
        if (!exercises || !Array.isArray(exercises) || exercises.length === 0) {
          console.log('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„é¢˜ç›®æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤é¢˜ç›®');
          exercises = defaultExercises;
          localStorage.setItem('exercises', JSON.stringify(defaultExercises));
        }
        
        // ç”Ÿæˆé¢˜ç›®
        currentExercises = exercises;
        generateExercises(exercises);
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œé¢˜ç›®å·²ç”Ÿæˆï¼Œå…±', exercises.length, 'ä¸ªé¢˜ç›®');
      } catch (error) {
        console.error('ç”Ÿæˆé¢˜ç›®æ—¶å‡ºé”™:', error);
        // å‘ç”Ÿé”™è¯¯æ—¶ä½¿ç”¨é»˜è®¤é¢˜ç›®
        generateExercises(defaultExercises);
        showFeedback('åŠ è½½é¢˜ç›®æ—¶å‡ºé”™ï¼Œå·²ä½¿ç”¨é»˜è®¤é¢˜ç›®');
      }
    }

    // åˆå§‹åŒ–åº”ç”¨
    window.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      initMouseHighlight();
    });
    
    // é¼ æ ‡é«˜äº®åŠŸèƒ½
    function initMouseHighlight() {
      const cursorHighlight = document.querySelector('.cursor-highlight');
      const cursorArrow = document.querySelector('.cursor-arrow');
      let currentCursor = 'highlight'; // 'default', 'highlight', 'arrow'
      
      // åˆå§‹æ¿€æ´»é«˜äº®æŒ‰é’®
      document.getElementById('cursor-highlight').classList.add('active');
      
      // æ›´æ–°é¼ æ ‡æŒ‡é’ˆä½ç½®
      document.addEventListener('mousemove', function(e) {
        if (currentCursor === 'default') return;
        
        // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨æ–‡å­—ã€è¾“å…¥æ¡†æˆ–æŒ‰é’®ä¸Š
        const target = e.target;
        const isOverInteractive = target.classList.contains('word') || 
                          target.closest('.word') || 
                          target.classList.contains('blank-input') || 
                          target.closest('.blank-input') ||
                          target.tagName === 'BUTTON' ||
                          target.tagName === 'INPUT';
        
        // æ›´æ–°é«˜äº®æŒ‡é’ˆä½ç½®
        const coords = { x: e.clientX, y: e.clientY };
        
        if (currentCursor === 'highlight') {
          cursorHighlight.style.left = coords.x + 'px';
          cursorHighlight.style.top = coords.y + 'px';
          // åœ¨äº’åŠ¨å…ƒç´ ä¸Šé™ä½é€æ˜åº¦
          cursorHighlight.style.opacity = isOverInteractive ? '0.3' : '1';
        } else if (currentCursor === 'arrow') {
          cursorArrow.style.left = coords.x + 'px';
          cursorArrow.style.top = coords.y + 'px';
          cursorArrow.style.display = 'block';
        }
      });
      
      // è®¾ç½®é¼ æ ‡æ•ˆæœç±»å‹
      function setCursorType(type) {
        // å…ˆé‡ç½®æ‰€æœ‰æ ·å¼
        currentCursor = type;
        document.body.style.cursor = 'auto';
        cursorHighlight.style.display = 'none';
        cursorArrow.style.display = 'none';
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.mouse-controls button').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
        if (type === 'default') {
          document.body.style.cursor = 'auto';
          document.getElementById('cursor-default').classList.add('active');
          showFeedback('å·²åˆ‡æ¢åˆ°é»˜è®¤é¼ æ ‡æŒ‡é’ˆ');
        } 
        else if (type === 'highlight') {
          document.body.style.cursor = 'none';
          cursorHighlight.style.display = 'block';
          document.getElementById('cursor-highlight').classList.add('active');
          showFeedback('å·²å¯ç”¨é«˜äº®æŒ‡é’ˆ');
        }
        else if (type === 'arrow') {
          document.body.style.cursor = 'none';
          cursorArrow.style.display = 'block';
          document.getElementById('cursor-arrow').classList.add('active');
          showFeedback('å·²å¯ç”¨ç®­å¤´æŒ‡é’ˆ');
        }
      }
      
      // ç»‘å®šæŒ‡é’ˆæ ·å¼æŒ‰é’®
      document.getElementById('cursor-default').addEventListener('click', function() {
        setCursorType('default');
      });
      
      document.getElementById('cursor-highlight').addEventListener('click', function() {
        setCursorType('highlight');
      });
      
      document.getElementById('cursor-arrow').addEventListener('click', function() {
        setCursorType('arrow');
      });
      
      // åˆå§‹è®¾ç½®
      setCursorType('highlight');
    }
    
    // æ˜¾ç¤ºæ‰€æœ‰ç­”æ¡ˆ
    document.getElementById('show-all-answers').addEventListener('click', function() {
      document.querySelectorAll('.blank-input').forEach(input => {
        const answer = input.dataset.answer;
        input.value = answer;
        input.parentElement.querySelector('.blank-content').style.opacity = '0';
        input.parentElement.classList.add("correct");
        input.setAttribute('readonly', true);
      });
      showFeedback('å·²æ˜¾ç¤ºæ‰€æœ‰ç­”æ¡ˆ');
    });
    
    // éšè—æ‰€æœ‰ç­”æ¡ˆ
    document.getElementById('hide-all-answers').addEventListener('click', function() {
      document.querySelectorAll('.blank-input').forEach(input => {
        input.value = '';
        input.parentElement.querySelector('.blank-content').style.opacity = '0.4';
        input.parentElement.classList.remove("correct");
        input.parentElement.classList.remove("incorrect");
        input.removeAttribute('readonly');
      });
      showFeedback('å·²éšè—æ‰€æœ‰ç­”æ¡ˆ');
    });

    // æ§åˆ¶ç¿»è¯‘æŒ‰é’®çš„æ˜¾ç¤º
    document.querySelector('.toggle-translate-btn').addEventListener('change', function() {
      if (this.checked) {
        document.querySelectorAll('.translate-btn').forEach(btn => {
          btn.classList.remove('hidden');
        });
      } else {
        document.querySelectorAll('.translate-btn').forEach(btn => {
          btn.classList.add('hidden');
        });
      }
    });

    // æ§åˆ¶æç¤ºç¿»è¯‘æŒ‰é’®çš„æ˜¾ç¤º
    document.querySelector('.toggle-hint-btn').addEventListener('change', function() {
      if (this.checked) {
        document.querySelectorAll('.hint-btn').forEach(btn => {
          btn.classList.remove('hidden');
        });
      } else {
        document.querySelectorAll('.hint-btn').forEach(btn => {
          btn.classList.add('hidden');
        });
      }
    });

    // æ§åˆ¶è§£ææŒ‰é’®çš„æ˜¾ç¤º
    document.querySelector('.toggle-explanation-btn').addEventListener('change', function() {
      if (this.checked) {
        document.querySelectorAll('.explanation-btn').forEach(btn => {
          btn.classList.remove('hidden');
        });
      } else {
        document.querySelectorAll('.explanation-btn').forEach(btn => {
          btn.classList.add('hidden');
        });
      }
    });

    // æ§åˆ¶è¯­æ³•ç»“æ„æŒ‰é’®çš„æ˜¾ç¤º
    document.querySelector('.toggle-grammar-btn').addEventListener('change', function() {
      if (this.checked) {
        document.querySelectorAll('.grammar-btn').forEach(btn => {
          btn.classList.remove('hidden');
        });
      } else {
        document.querySelectorAll('.grammar-btn').forEach(btn => {
          btn.classList.add('hidden');
        });
      }
    });

    // æ§åˆ¶æ˜¾ç¤ºç­”æ¡ˆæŒ‰é’®çš„æ˜¾ç¤º
    document.querySelector('.toggle-show-answer-btn').addEventListener('change', function() {
      if (this.checked) {
        document.querySelectorAll('.show-answer-btn').forEach(btn => {
          btn.classList.remove('hidden');
        });
      } else {
        document.querySelectorAll('.show-answer-btn').forEach(btn => {
          btn.classList.add('hidden');
        });
      }
    });

    // æ§åˆ¶æ˜¾ç¤ºæ‰€æœ‰å•è¯é‡Šä¹‰çš„æ˜¾ç¤º
    document.querySelector('.toggle-show-all-meanings').addEventListener('change', function() {
      if (this.checked) {
        document.querySelectorAll('.word').forEach(word => {
          word.style.pointerEvents = 'auto';
        });
        showFeedback('å·²å¯ç”¨å•è¯é‡Šä¹‰æ˜¾ç¤º');
      } else {
        document.querySelectorAll('.word').forEach(word => {
          word.style.pointerEvents = 'none';
        });
        showFeedback('å·²ç¦ç”¨å•è¯é‡Šä¹‰æ˜¾ç¤º');
      }
    });
  </script>

</body>
</html>
